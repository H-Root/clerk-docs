---
description: Learn how to use Clerk's API to build a custom flow for managing multi-factor authentication.
---

# Build a custom flow for managing multi-factor authentication

<Callout type="danger">
  This guide is for users who want to build a *custom* user interface using the Clerk API. To allow your users to manage their MFA settings using a *prebuilt* UI, you should use Clerk's [Account Portal pages](/docs/account-portal/overview) or [prebuilt components](/docs/components/overview).
</Callout>

[Multi-factor verification (MFA)](/docs/authentication/configuration/sign-up-sign-in-options) is an added layer of security that requires users to provide a second verification factor to access an account.

Clerk supports second factor verification through **SMS verification code**, **Authenticator application**, and **Backup codes**.

This guide will walk you through how to build a custom flow that allows users to manage their MFA settings.

<Steps>

### Enable multi-factor authentication

For your users to be able to enable MFA for their account, you need to enable MFA as an authentication strategy in your Clerk application.

1. Navigate to your Clerk Dashboard.
2. Select your application, then select **User & Authentication > [Multi-factor](https://dashboard.clerk.com/last-active?path=user-authentication/multi-factor)** in the sidebar menu.
3. Enable the MFA options you want to support. This guide demonstrates how to support all MFA options. Note that for a user to enable **Backup codes** on their account, they must have one other MFA strategy enabled.

### Create the multi-factor management flow

<Tabs items={["Next.js"]}>
  <Tab>

    <Tabs items={["Manage MFA page", "Add TOTP page", "Add phone page"]}>
      <Tab>
        ```jsx {{ filename: 'app/account/manage-mfa/page.tsx' }}
        'use client';

        import * as React from 'react';
        import { useUser } from '@clerk/nextjs';
        import Link from 'next/link';
        import {
          BackupCodeResource,
          PhoneNumberResource,
          UserResource,
        } from '@clerk/types';

        // Display phone numbers reserved for MFA
        const ManageMfaPhoneNumbers = ({ user }: { user: UserResource }) => {
          // Check if any phone numbers are reserved for MFA
          const mfaPhones = user.phoneNumbers
            .filter((ph) => ph.verification.status === 'verified')
            .filter((ph) => ph.reservedForSecondFactor)
            .sort((ph: PhoneNumberResource) => (ph.defaultSecondFactor ? -1 : 1));

          return (
            <>
              <h2>Phone numbers reserved for MFA</h2>
              {mfaPhones.length === 0 && <p>No phone numbers reserved for MFA</p>}
              <table>
                <tr>
                  <th>Phone number</th>
                  <th>Actions</th>
                </tr>
                {mfaPhones.map((phone) => {
                  return (
                    <tr key={phone.id}>
                      <td>
                        {phone.phoneNumber} {phone.defaultSecondFactor && '(Default)'}
                      </td>
                      <td>
                        <div>
                          <button
                            onClick={() =>
                              phone.setReservedForSecondFactor({ reserved: false })
                            }
                          >
                            Disable for MFA
                          </button>
                        </div>

                        {!phone.defaultSecondFactor && (
                          <div>
                            <button onClick={() => phone.makeDefaultSecondFactor()}>
                              Make default
                            </button>
                          </div>
                        )}

                        <div>
                          <button onClick={() => phone.destroy()}>
                            Remove from account
                          </button>
                        </div>
                      </td>
                    </tr>
                  );
                })}
              </table>
            </>
          );
        };

        // Display phone numbers that are not reserved for MFA
        const ManageAvailablePhoneNumbers = ({ user }: { user: UserResource }) => {
          // Check if any phone numbers aren't reserved for MFA
          const availalableForMfaPhones = user.phoneNumbers
            .filter((ph) => ph.verification.status === 'verified')
            .filter((ph) => !ph.reservedForSecondFactor);

          // Reserve a phone number for MFA
          const reservePhoneForMfa = async (phone: PhoneNumberResource) => {
            // Set the phone number as reserved for MFA
            await phone.setReservedForSecondFactor({ reserved: true });
            // Refresh the user information to reflect changes
            await user.reload();
          };

          return (
            <>
              <h2>Phone numbers that are not reserved for MFA</h2>
              {availalableForMfaPhones.length === 0 ? (
                <p>
                  None -{' '}
                  <Link href="/account/add-phone">
                    Add a new phone number
                  </Link>
                </p>
              ) : (
                <table>
                  <tr>
                    <th>Phone number</th>
                    <th>Actions</th>
                  </tr>
                  {availalableForMfaPhones.map((phone) => {
                    return (
                      <tr key={phone.id}>
                        <td>{phone.phoneNumber}</td>
                        <td>
                          <button onClick={() => reservePhoneForMfa(phone)}>
                            Use for MFA
                          </button>
                          <button onClick={() => phone.destroy()}>
                            Remove from account
                          </button>
                        </td>
                      </tr>
                    );
                  })}
                </table>
              )}
            </>
          );
        };

        // If TOTP is enabled, provide the option to disable it
        const TotpEnabled = ({ user }: { user: UserResource }) => {
          const disableTOTP = async () => {
            await user.disableTOTP();
          };

          return (
            <div>
              <p>
                TOTP via authenication app enabled -{' '}
                <button onClick={() => disableTOTP()}>Remove</button>
              </p>
            </div>
          );
        };

        // If TOTP is disabled, provide the option to enable it
        const TotpDisabled = () => {
          return (
            <div>
              <p>
                Add TOTP via authentication app -{' '}
                <Link href="/account/manage-mfa/add-totp">
                  <button>Add</button>
                </Link>
              </p>
            </div>
          );
        };

        // Generate and display backup codes
        function GenerateBackupCodes() {
          const { user } = useUser();
          const [backupCodes, setBackupCodes] = React.useState<
            BackupCodeResource | undefined
          >(undefined);

          const [loading, setLoading] = React.useState(false);

          React.useEffect(() => {
            if (backupCodes) {
              return;
            }

            setLoading(true);
            void user
              ?.createBackupCode()
              .then((backupCode: BackupCodeResource) => {
                setBackupCodes(backupCode);
                setLoading(false);
              })
              .catch((err) => {
                console.error(JSON.stringify(err, null, 2));
                setLoading(false);
              });
          }, []);

          if (loading) {
            return <p>Loading...</p>;
          }

          if (!backupCodes) {
            return <p>There was a problem generating backup codes</p>;
          }

          return (
            <ol>
              {!loading &&
                backupCodes.codes.map((code, index) => <li key={index}>{code}</li>)}
            </ol>
          );
        }

        export default function ManageMFA() {
          const { isLoaded, user } = useUser();
          const [showNewCodes, setShowNewCodes] = React.useState(false);

          if (!isLoaded) return null;

          if (isLoaded && !user) {
            return <p>You must be logged in to access this page</p>;
          }

          return (
            <>
              <h1>User MFA Settings</h1>

              {/* Manage SMS MFA */}
              <ManageMfaPhoneNumbers user={user} />
              <ManageAvailablePhoneNumbers user={user} />

              {/* Manage TOTP MFA */}
              {user.totpEnabled ? <TotpEnabled user={user} /> : <TotpDisabled />}

              {/* Manage backup codes */}
              {user.backupCodeEnabled && (
                <div>
                  <p>
                    Generate new codes? -{' '}
                    <button onClick={() => setShowNewCodes(true)}>Generate</button>
                  </p>
                </div>
              )}
              {showNewCodes && (
                <>
                  <GenerateBackupCodes />
                  <button onClick={() => setShowNewCodes(false)}>Done</button>
                </>
              )}
            </>
          );
        }
        ```
      </Tab>

      <Tab>
        ```jsx {{ filename: 'app/account/manage-mfa/add-totp/page.tsx' }}
        'use client';

        import { useUser } from '@clerk/nextjs';
        import { BackupCodeResource, TOTPResource, UserResource } from '@clerk/types';
        import Link from 'next/link';
        import * as React from 'react';
        import { QRCodeSVG } from 'qrcode.react';

        type AddTotpSteps = 'add' | 'verify' | 'backupcodes' | 'success';

        type DisplayFormat = 'qr' | 'uri';

        function AddTotpScreen({
          setStep,
          user,
        }: {
          setStep: React.Dispatch<React.SetStateAction<AddTotpSteps>>;
          user: UserResource;
        }) {
          const [totp, setTOTP] = React.useState<TOTPResource | undefined>(undefined);
          const [displayFormat, setDisplayFormat] = React.useState<DisplayFormat>('qr');

          React.useEffect(() => {
            void user
              .createTOTP()
              .then((totp: TOTPResource) => {
                setTOTP(totp);
              })
              .catch((err) =>
                // See https://clerk.com/docs/custom-flows/error-handling
                // for more info on error handling
                console.error(JSON.stringify(err, null, 2))
              );
          }, []);

          return (
            <>
              <h1>Add TOTP MFA</h1>

              {totp && displayFormat === 'qr' && (
                <>
                  <div>
                    <QRCodeSVG value={totp?.uri || ''} size={200} />
                  </div>
                  <button onClick={() => setDisplayFormat('uri')}>
                    Use URI instead
                  </button>
                </>
              )}
              {totp && displayFormat === 'uri' && (
                <>
                  <div>
                    <p>{totp.uri}</p>
                  </div>
                  <button onClick={() => setDisplayFormat('qr')}>
                    Use QR Code instead
                  </button>
                </>
              )}
              <button onClick={() => setStep('add')}>Reset</button>

              <p>Once you have set up your authentication app, verify your code</p>
              <button onClick={() => setStep('verify')}>Verify</button>
            </>
          );
        }

        function VerifyTotpScreen({
          setStep,
          user,
        }: {
          setStep: React.Dispatch<React.SetStateAction<AddTotpSteps>>;
          user: UserResource;
        }) {
          const [code, setCode] = React.useState('');

          const verifyTotp = async (e: React.FormEvent) => {
            e.preventDefault();
            try {
              await user.verifyTOTP({ code });
              setStep('backupcodes');
            } catch (err) {
              console.error(JSON.stringify(err, null, 2));
            }
          };

          return (
            <>
              <h1>Verify TOTP</h1>
              <form onSubmit={(e) => verifyTotp(e)}>
                <label htmlFor="totp-code">
                  Enter the code from your authentication app
                </label>
                <input
                  type="text"
                  id="totp-code"
                  onChange={(e) => setCode(e.currentTarget.value)}
                />
                <button type="submit">Verify code</button>
                <button onClick={() => setStep('add')}>Reset</button>
              </form>
            </>
          );
        }

        // Generate and display backup codes
        function GenerateBackupCodes({
          setStep,
          user,
        }: {
          setStep: React.Dispatch<React.SetStateAction<AddTotpSteps>>;
          user: UserResource;
        }) {
          const [backupCodes, setBackupCodes] = React.useState<
            BackupCodeResource | undefined
          >(undefined);

          const [loading, setLoading] = React.useState(false);

          React.useEffect(() => {
            if (backupCodes) return;

            setLoading(true);

            void user
              .createBackupCode()
              .then((backupCode: BackupCodeResource) => {
                setBackupCodes(backupCode);
                setLoading(false);
              })
              .catch((err) => {
                console.error(JSON.stringify(err, null, 2));
                setLoading(false);
              });
          }, []);

          if (loading) {
            return <p>Loading...</p>;
          }

          if (!backupCodes) {
            return <p>There was a problem generating backup codes</p>;
          }

          return (
            <>
              <h1>Backup codes</h1>
              <div>
                <p>
                  Save this list of backup codes somewhere safe in case you need to
                  access your account in an emergency
                </p>
                <ol>
                  {!loading &&
                    backupCodes.codes.map((code, index) => <li key={index}>{code}</li>)}
                </ol>
                <button onClick={() => setStep('success')}>Finish</button>
              </div>
            </>
          );
        }

        function SuccessScreen() {
          return (
            <>
              <h1>Success!</h1>
              <p>
                You have successfully added TOTP MFA via an authentication application.
              </p>
            </>
          );
        }

        export default function AddTOTP() {
          const [step, setStep] = React.useState<AddTotpSteps>('add');
          const { isLoaded, user } = useUser();

          if (!isLoaded) return null;

          if (isLoaded && !user?.id) {
            return <p>You must be logged in to access this page</p>;
          }

          return (
            <>
              {step === 'add' && <AddTotpScreen user={user} setStep={setStep} />}
              {step === 'verify' && <VerifyTotpScreen user={user} setStep={setStep} />}
              {step === 'backupcodes' && (
                <GenerateBackupCodes user={user} setStep={setStep} />
              )}
              {step === 'success' && <SuccessScreen />}
              <Link href="/account/manage-mfa">Manage MFA</Link>
            </>
          );
        }
        ```
      </Tab>

      <Tab>
        {/* add phone custom flow example from other PR? */}
      </Tab>
    </Tabs>
  </Tab>
</Tabs>

</Steps>

## Next steps

Now that users can enable MFA for their account, you need to add support for MFA in your sign-in flow. [Learn how to build a custom email/password sign-in flow that requires multi-factor authentication.](/docs/custom-flows/email-password-mfa)
