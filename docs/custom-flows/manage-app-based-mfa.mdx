---
title: Manage application based Multi-factor Authentication
description: Learn how to manage application based multi-factor authentication, to enable the same features as in the User Profile component.
---

# Manage application based Multi-factor Authentication


```jsx {{ filename: 'app/account/manage-mfa/page.tsx' }}
'use client';

import * as React from 'react';
import { useUser } from '@clerk/nextjs';
import Link from 'next/link';
import { BackupCodeResource } from '@clerk/types';

// If TOTP is enabled, show its enabled and provide the option to disable
const TotpEnabled = () => {
  const { user } = useUser();
  if (!user) return null;

  // Check if TOTP is enabled
  const disableTOTP = async () => {
    await user.disableTOTP();
  };

  return (
    <div>
      <p>
        TOTP via authenication app enabled -{' '}
        <button onClick={() => disableTOTP()}>Remove</button>
      </p>
    </div>
  );
};

// If TOTP is not enabled, provide the option to enable it
const TotpDisabled = () => {
  return (
    <div>
      <p>
        Add TOTP via authentication app -{' '}
        <Link href="/account/manage-mfa/add">
          <button>Add</button>
        </Link>
      </p>
    </div>
  );
};

export default function ManageTOTP() {
  const [backupCodes, setBackupCodes] = React.useState<
    BackupCodeResource | undefined
  >(undefined);
  const [loading, setLoading] = React.useState(false);
  const { isLoaded, user } = useUser();

  if (!isLoaded || !user) return null;

  const generateBackupCodes = () => {
    setLoading(true);
    void user
      ?.createBackupCode()
      .then((backupCodes: BackupCodeResource) => {
        setBackupCodes(backupCodes);
        setLoading(false);
      })
      .catch((error) => {
        console.log('Error:', error);
        setLoading(false);
      });
  };

  return (
    <>
      <h1>User Authentication Settings</h1>

      {user.totpEnabled ? <TotpEnabled /> : <TotpDisabled />}

      {user.backupCodeEnabled && (
        <div>
          <p>Backup codes</p>
          {loading && <p>Loading...</p>}
          {backupCodes && !loading && (
            <ol>
              {backupCodes.codes.map((code, index) => (
                <li key={index}>{code}</li>
              ))}
            </ol>
          )}
          <button onClick={() => generateBackupCodes()}>Regenerate</button>
        </div>
      )}
    </>
  );
}
```



```jsx {{ filename: 'app/account/manage-mfa/add/page.tsx' }}
'use client';

import { useUser } from '@clerk/nextjs';
import { BackupCodeResource, TOTPResource } from '@clerk/types';
import Link from 'next/link';
import * as React from 'react';
import { QRCodeSVG } from 'qrcode.react';

type AddTotpSteps = 'add' | 'verify' | 'backupcodes' | 'success';

type DisplayFormat = 'qr' | 'uri';

function AddTotpScreen({
  setStep,
}: {
  setStep: React.Dispatch<React.SetStateAction<AddTotpSteps>>;
}) {
  const [totp, setTOTP] = React.useState<TOTPResource | undefined>(undefined);
  const [displayFormat, setDisplayFormat] = React.useState<DisplayFormat>('qr');
  const { user } = useUser();

  React.useEffect(() => {
    void user
      ?.createTOTP()
      .then((totp: TOTPResource) => {
        setTOTP(totp);
      })
      .catch((error) => console.log('Error', error));
  }, []);

  return (
    <>
      <h1>Add TOTP MFA</h1>

      {totp && displayFormat === 'qr' && (
        <>
          <div>
            <QRCodeSVG value={totp?.uri || ''} size={200} />
          </div>
          <button onClick={() => setDisplayFormat('uri')}>
            Use URI instead
          </button>
        </>
      )}
      {totp && displayFormat === 'uri' && (
        <>
          <div>
            <p>{totp.uri}</p>
          </div>
          <button onClick={() => setDisplayFormat('qr')}>
            Use QR Code instead
          </button>
        </>
      )}
      <button onClick={() => setStep('add')}>Reset</button>

      <p>Once you have set up your authentication app, verify your code</p>
      <button onClick={() => setStep('verify')}>Verify</button>
    </>
  );
}

function VerifyTotpScreen({
  setStep,
}: {
  setStep: React.Dispatch<React.SetStateAction<AddTotpSteps>>;
}) {
  const [code, setCode] = React.useState('');
  const { user } = useUser();

  const verifyTotp = async (e: React.FormEvent) => {
    e.preventDefault();
    try {
      await user?.verifyTOTP({ code });
      setStep('backupcodes');
    } catch (err) {
      // See https://clerk.com/docs/custom-flows/error-handling
      // for more info on error handling
      console.error(JSON.stringify(err, null, 2));
    }
  };

  return (
    <>
      <h1>Verify TOTP</h1>
      <form onSubmit={(e) => verifyTotp(e)}>
        <label htmlFor="totp-code">
          Enter the code from your authentication app
        </label>
        <input
          type="text"
          id="totp-code"
          onChange={(e) => setCode(e.currentTarget.value)}
        />
        <button type="submit">Verify code</button>
        <button onClick={() => setStep('add')}>Reset</button>
      </form>
    </>
  );
}

function DisplayBackupCodes() {
  const { user } = useUser();
  const [backupCode, setBackupCode] = React.useState<
    BackupCodeResource | undefined
  >(undefined);

  React.useEffect(() => {
    if (backupCode) {
      return;
    }

    void user
      ?.createBackupCode()
      .then((backupCode: BackupCodeResource) => setBackupCode(backupCode))
      .catch((error) => console.log('Error:', error));
  }, []);

  if (!backupCode) {
    return <p>There was a problem generating backup codes</p>;
  }

  return (
    <ol>
      {backupCode.codes.map((code, index) => (
        <li key={index}>{code}</li>
      ))}
    </ol>
  );
}

function BackupCodeScreen({
  setStep,
}: {
  setStep: React.Dispatch<React.SetStateAction<AddTotpSteps>>;
}) {
  return (
    <>
      <h1>Backup codes</h1>
      <div>
        <p>
          Save this list of backup codes somewhere safe in case you need to
          access your account in an emergency
        </p>
        <DisplayBackupCodes />
        <button onClick={() => setStep('success')}>Finish</button>
      </div>
    </>
  );
}

function SuccessScreen() {
  return (
    <>
      <h1>Success!</h1>
      <p>
        You have successfully added TOTP MFA via an authentication application
      </p>
    </>
  );
}

export default function AddMfaScreen() {
  const [step, setStep] = React.useState<AddTotpSteps>('add');

  return (
    <>
      {step === 'add' && <AddTotpScreen setStep={setStep} />}
      {step === 'verify' && <VerifyTotpScreen setStep={setStep} />}
      {step === 'backupcodes' && <BackupCodeScreen setStep={setStep} />}
      {step === 'success' && <SuccessScreen />}
      <Link href="/account/manage-mfa">Manage MFA</Link>
    </>
  );
}
```
